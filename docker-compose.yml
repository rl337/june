services:
  base:
    build:
      context: .
      dockerfile: ./services/base/Dockerfile
    image: june-base:latest
    profiles:
    - tools
    volumes:
    - /var/log/june/base:/logs
  orchestrator:
    build:
      context: .
      dockerfile: ./services/orchestrator/Dockerfile
    container_name: june-orchestrator
    restart: unless-stopped
    ports:
    - 8007:8005
    environment:
    - ORCHESTRATOR_PORT=8005
    - GATEWAY_URL=http://gateway:8000
    - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
    - gateway
    healthcheck:
      test:
      - CMD
      - wget
      - -q
      - --spider
      - http://localhost:8005/health
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
    - june_network
    volumes:
    - /var/log/june/orchestrator:/logs
  webapp:
    build:
      context: ./services/webapp
      dockerfile: Dockerfile
    container_name: june-webapp
    restart: unless-stopped
    ports:
    - 3001:3000
    environment:
    - REACT_APP_GATEWAY_URL=http://localhost:8000
    - REACT_APP_WS_URL=ws://localhost:8000
    depends_on:
    - gateway
    volumes:
    - ./services/webapp:/app
    - /app/node_modules
    - /var/log/june/webapp:/logs
    networks:
    - june_network
  cli-tools:
    build:
      context: .
      dockerfile: ./services/cli-tools/Dockerfile
    container_name: june-cli-tools
    environment:
    - MODEL_CACHE_DIR=/models
    - HUGGINGFACE_CACHE_DIR=/models/huggingface
    - TRANSFORMERS_CACHE_DIR=/models/transformers
    - HUGGINGFACE_TOKEN=${HUGGINGFACE_TOKEN}
    volumes:
    - ${MODEL_CACHE_DIR:-/home/rlee/models}:/models
    - ${JUNE_DATA_DIR:-/home/rlee/june_data}:/data
    - ${JUNE_TEST_DATA_DIR:-/home/rlee/june_test_data}:/test_data
    - ./services/cli-tools/scripts:/app/scripts
    - ./scripts:/app/root_scripts
    - ./services/gateway/tests:/app/gateway_tests
    - /var/log/june/cli-tools:/logs
    extra_hosts:
    - host.docker.internal:host-gateway
    networks:
    - june_network
    profiles:
    - tools
    command:
    - bash
    - -c
    - 'echo ''CLI Tools container ready. Use: docker exec -it june-cli-tools bash''
      && tail -f /dev/null'
  mock-sink:
    build:
      context: ./services/mock-sink
      dockerfile: Dockerfile
    container_name: june-mock-sink
    restart: unless-stopped
    ports:
    - 7000:7000
    volumes:
    - ${JUNE_DATA_DIR:-/home/rlee/june_data}/model_artifacts/mock-sink:/app/model_artifacts
    - /var/log/june/mock-sink:/logs
    networks:
    - june_network
    profiles:
    - tools
  gateway:
    build:
      context: .
      dockerfile: ./services/gateway/Dockerfile
    restart: unless-stopped
    expose:
    - '8000'
    environment:
    - INFERENCE_API_URL=grpc://inference-api:50051
    - STT_URL=grpc://stt:50052
    - TTS_URL=grpc://tts:50053
    - NATS_URL=nats://common-nats:4222
    - POSTGRES_URL=postgresql://june:${POSTGRES_PASSWORD:-changeme}@common-postgres:5432/june
    - MINIO_ENDPOINT=common-minio:9000
    - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-admin}
    - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-changeme}
    - REDIS_URL=redis://common-redis:6379/0
    - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
    - JWT_SECRET=${JWT_SECRET:-change-this-secret}
    - ENCRYPTION_KEY=${ENCRYPTION_KEY:-}
    - ENABLE_DB_ENCRYPTION=${ENABLE_DB_ENCRYPTION:-true}
    volumes:
    - ${JUNE_DATA_DIR:-/home/rlee/june_data}/model_artifacts/gateway:/app/model_artifacts
    - ./services/gateway:/app
    - /var/log/june/gateway:/logs
    healthcheck:
      test:
      - CMD
      - wget
      - -q
      - --spider
      - http://localhost:8000/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
    - june_network
    - shared-network
  inference-api:
    build:
      context: .
      dockerfile: ./services/inference-api/Dockerfile
    container_name: june-inference-api
    restart: unless-stopped
    ports:
    - 50051:50051
    environment:
    - MODEL_NAME=${MODEL_NAME:-Qwen/Qwen3-30B-A3B-Thinking-2507}
    - MODEL_DEVICE=${MODEL_DEVICE:-cuda:0}
    - MAX_CONTEXT_LENGTH=${MAX_CONTEXT_LENGTH:-131072}
    - USE_YARN=${USE_YARN:-true}
    - MODEL_TEMPERATURE=${MODEL_TEMPERATURE:-0.7}
    - MODEL_MAX_TOKENS=${MODEL_MAX_TOKENS:-2048}
    - MODEL_TOP_P=${MODEL_TOP_P:-0.9}
    - MODEL_TOP_K=${MODEL_TOP_K:-}
    - MODEL_REPETITION_PENALTY=${MODEL_REPETITION_PENALTY:-}
    - POSTGRES_URL=postgresql://june:${POSTGRES_PASSWORD:-changeme}@postgres:5432/june
    - MINIO_ENDPOINT=minio:9000
    - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-admin}
    - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-changeme}
    - NATS_URL=nats://common-nats:4222
    - HUGGINGFACE_TOKEN=${HUGGINGFACE_TOKEN}
    - CUDA_VISIBLE_DEVICES=0
    - CUDA_MPS_ENABLE_PER_CTX_SM_PARTITIONING=1
    deploy:
      resources:
        reservations:
          devices:
          - driver: nvidia
            device_ids:
            - '0'
            capabilities:
            - gpu
    depends_on:
    - postgres
    - minio
    volumes:
    - ${MODEL_CACHE_DIR:-/home/rlee/models}:/models
    - ${JUNE_DATA_DIR:-/home/rlee/june_data}/model_artifacts/inference-api:/app/model_artifacts
    - /var/log/june/inference-api:/logs
    networks:
    - june_network
    - shared-network
  stt:
    build:
      context: .
      dockerfile: ./services/stt/Dockerfile
    restart: unless-stopped
    ports:
    - 50052:50052
    environment:
    - MODEL_NAME=${STT_MODEL:-openai/whisper-large-v3}
    - MODEL_DEVICE=${STT_DEVICE:-cuda:0}
    - MODEL_CACHE_DIR=/models
    - NATS_URL=nats://common-nats:4222
    - HUGGINGFACE_TOKEN=${HUGGINGFACE_TOKEN}
    - CUDA_VISIBLE_DEVICES=0
    - CUDA_MPS_ENABLE_PER_CTX_SM_PARTITIONING=1
    deploy:
      resources:
        reservations:
          devices:
          - driver: nvidia
            device_ids:
            - '0'
            capabilities:
            - gpu
    volumes:
    - ${MODEL_CACHE_DIR:-/home/rlee/models}:/models
    - ${JUNE_DATA_DIR:-/home/rlee/june_data}/model_artifacts/stt:/app/model_artifacts
    - /var/log/june/stt:/logs
    healthcheck:
      test:
      - CMD
      - python
      - -c
      - import grpc; grpc.insecure_channel('localhost:50052').check_connectivity_state(True)
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
    - june_network
    - shared-network
  tts:
    build:
      context: .
      dockerfile: ./services/tts/Dockerfile
    restart: unless-stopped
    ports:
    - 50053:50053
    environment:
    - MODEL_NAME=${TTS_MODEL:-facebook/fastspeech2-en-ljspeech}
    - MODEL_DEVICE=${TTS_DEVICE:-cuda:0}
    - NATS_URL=nats://common-nats:4222
    - HUGGINGFACE_TOKEN=${HUGGINGFACE_TOKEN}
    - CUDA_VISIBLE_DEVICES=0
    - CUDA_MPS_ENABLE_PER_CTX_SM_PARTITIONING=1
    deploy:
      resources:
        reservations:
          devices:
          - driver: nvidia
            device_ids:
            - '0'
            capabilities:
            - gpu
    volumes:
    - ${MODEL_CACHE_DIR:-/home/rlee/models}:/models
    - ${JUNE_DATA_DIR:-/home/rlee/june_data}/model_artifacts/tts:/app/model_artifacts
    - ./services/tts:/app
    - /var/log/june/tts:/logs
    healthcheck:
      test:
      - CMD
      - python
      - -c
      - import grpc; grpc.insecure_channel('localhost:50053').check_connectivity_state(True)
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
    - june_network
    - shared-network
  telegram:
    build:
      context: .
      dockerfile: ./services/telegram/Dockerfile
    restart: unless-stopped
    ports:
    - 8080:8080
    - 8443:8443
    environment:
    - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
    - TELEGRAM_AUTHORIZED_USERS=${TELEGRAM_AUTHORIZED_USERS:-39833618}
    - CURSOR_AGENT_EXE=/usr/local/bin/cursor-tools/cursor-agent
    - CURSOR_API_KEY=${CURSOR_API_KEY:-}
    - CURSOR_AGENT=1
    - PATH=/usr/local/bin/cursor-tools:${PATH}
    - AGENTICNESS_STATE_DIR=/app/agenticness-state
    - NODE_ENV=development
    - TERM=dumb
    - HOSTNAME=${HOSTNAME:-telegram}
    - TELEGRAM_SERVICE_PORT=8080
    - TELEGRAM_USE_WEBHOOK=${TELEGRAM_USE_WEBHOOK:-false}
    - TELEGRAM_WEBHOOK_URL=${TELEGRAM_WEBHOOK_URL:-}
    - TELEGRAM_WEBHOOK_PORT=8443
    - TELEGRAM_WEBHOOK_PATH=/webhook
    - TELEGRAM_REQUEST_TIMEOUT=${TELEGRAM_REQUEST_TIMEOUT:-30.0}
    - TELEGRAM_RATE_LIMIT_PER_MINUTE=${TELEGRAM_RATE_LIMIT_PER_MINUTE:-10}
    - TELEGRAM_RATE_LIMIT_PER_HOUR=${TELEGRAM_RATE_LIMIT_PER_HOUR:-100}
    - TELEGRAM_RATE_LIMIT_PER_DAY=${TELEGRAM_RATE_LIMIT_PER_DAY:-500}
    - GRPC_MAX_CONNECTIONS_PER_SERVICE=${GRPC_MAX_CONNECTIONS_PER_SERVICE:-10}
    - GRPC_KEEPALIVE_TIME_MS=${GRPC_KEEPALIVE_TIME_MS:-30000}
    - GRPC_KEEPALIVE_TIMEOUT_MS=${GRPC_KEEPALIVE_TIMEOUT_MS:-5000}
    - LOG_LEVEL=${LOG_LEVEL:-INFO}
    - STT_URL=grpc://stt:50052
    - TTS_URL=grpc://tts:50053
    - LLM_URL=grpc://inference-api:50051
    - NATS_URL=nats://common-nats:4222
    - USE_VOICE_QUEUE=${USE_VOICE_QUEUE:-false}
    depends_on:
    - stt
    - tts
    - inference-api
    healthcheck:
      test:
      - CMD
      - wget
      - -q
      - --spider
      - http://localhost:8080/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
    - ${AGENTICNESS_DIR:-/home/rlee/dev/agenticness}:/app/agenticness:ro
    - ${HOME}/.local/share/cursor-agent/versions/2025.11.06-8fe8a63:/usr/local/bin/cursor-tools:ro
    - ${JUNE_DATA_DIR:-/home/rlee/june_data}/agenticness-state:/app/agenticness-state
    - ${HOME}/.config/cursor/auth.json:/home/june/.config/cursor/auth.json:ro
    - ${JUNE_DATA_DIR:-/home/rlee/june_data}/cursor-container-config:/home/june/.config/cursor:rw
    - ./config/cursor-mcp-config.json:/home/june/.config/cursor/mcp.json:ro
    - ${HOME}/.cursor:/home/june/.cursor:rw
    - /var/log/june/telegram:/logs
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    networks:
    - june_network
    - shared-network
  discord:
    build:
      context: .
      dockerfile: ./services/discord/Dockerfile
    restart: unless-stopped
    ports:
    - 8081:8081
    environment:
    - DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN:-}
    - DISCORD_AUTHORIZED_USERS=${DISCORD_AUTHORIZED_USERS:-}
    - CURSOR_AGENT_EXE=/usr/local/bin/cursor-tools/cursor-agent
    - CURSOR_API_KEY=${CURSOR_API_KEY:-}
    - CURSOR_AGENT=1
    - PATH=/usr/local/bin/cursor-tools:${PATH}
    - AGENTICNESS_STATE_DIR=/app/agenticness-state
    - NODE_ENV=development
    - TERM=dumb
    - HOSTNAME=${HOSTNAME:-discord}
    - DISCORD_SERVICE_PORT=8081
    - GRPC_MAX_CONNECTIONS_PER_SERVICE=${GRPC_MAX_CONNECTIONS_PER_SERVICE:-10}
    - GRPC_KEEPALIVE_TIME_MS=${GRPC_KEEPALIVE_TIME_MS:-30000}
    - GRPC_KEEPALIVE_TIMEOUT_MS=${GRPC_KEEPALIVE_TIMEOUT_MS:-5000}
    - LOG_LEVEL=${LOG_LEVEL:-INFO}
    - STT_URL=grpc://stt:50052
    - TTS_URL=grpc://tts:50053
    - LLM_URL=grpc://inference-api:50051
    depends_on:
    - stt
    - tts
    - inference-api
    volumes:
    - ${AGENTICNESS_DIR:-/home/rlee/dev/agenticness}:/app/agenticness:ro
    - ${HOME}/.local/share/cursor-agent/versions/2025.11.06-8fe8a63:/usr/local/bin/cursor-tools:ro
    - ${JUNE_DATA_DIR:-/home/rlee/june_data}/agenticness-state:/app/agenticness-state
    - ${HOME}/.config/cursor/auth.json:/home/june/.config/cursor/auth.json:ro
    - ${JUNE_DATA_DIR:-/home/rlee/june_data}/cursor-container-config:/home/june/.config/cursor:rw
    - ./config/cursor-mcp-config.json:/home/june/.config/cursor/mcp.json:ro
    - ${HOME}/.cursor:/home/june/.cursor:rw
    - /var/log/june/discord:/logs
    networks:
    - june_network
    - shared-network
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:8081/health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
  telegram-voice-worker:
    build:
      context: .
      dockerfile: ./services/telegram/Dockerfile
    restart: unless-stopped
    command:
    - python
    - voice_worker.py
    environment:
    - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
    - LOG_LEVEL=${LOG_LEVEL:-INFO}
    - STT_URL=grpc://stt:50052
    - TTS_URL=grpc://tts:50053
    - LLM_URL=grpc://inference-api:50051
    - NATS_URL=nats://common-nats:4222
    - WORKER_ID=worker-${HOSTNAME}
    - stt
    - tts
    - inference-api
    networks:
    - june_network
    - shared-network
    profiles:
    - workers
    volumes:
    - /var/log/june/telegram-voice-worker:/logs
networks:
  june_network:
    driver: bridge
  shared-network:
    external: true
    name: shared_network
